#Requires -RunAsAdministrator

## Detect Script for CVE-2022-30190

# Make a working directory in c:\temp
mkdir C:\Temp\CVE-2022-30190\

# Log the detection actions
Start-Transcript -Append C:\Temp\CVE-2022-30190\ms-msdt.log


Write-Output "Starting detection for CVE-2022-30190 - MSDT registry key"

# Create a new PSDrive for HKEY_Classes_Root (hive)
New-PSDrive -PSProvider Registry HKCR -Root HKEY_CLASSES_ROOT -ErrorAction SilentlyContinue
Test-Path -Path 'HKCR:\ms-msdt'

if (Test-Path -Path 'HKCR:\ms-msdt') {
    Write-Output "Above result returned True, exiting"
    Remove-PSDrive -Name HKCR
	
	# Export key to C:\Temp\CVE-2022-30190\
	Write-Output "Export ms-msdt key"
	reg export HKEY_CLASSES_ROOT\ms-msdt C:\Temp\CVE-2022-30190\ms-msdt.reg

	# Delete the registry key
	Write-Output "Deleting ms-msdt key"
	reg delete HKEY_CLASSES_ROOT\ms-msdt /f

Write-Output "Mitigation finished"
    Stop-Transcript
    Exit 1
}
else {
    Write-Output "Above result returned False, exiting"
    Remove-PSDrive -Name HKCR
    Stop-Transcript
    Exit 0
}